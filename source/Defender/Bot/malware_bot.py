import os
import logging
import requests
import hashlib
import tempfile
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
from pathlib import Path

class MalwareScannerBot:
    def __init__(self, bot_token, vt_api_key):
        self.bot_token = bot_token
        self.vt_api_key = vt_api_key
        
        # Setup logging
        logging.basicConfig(
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            level=logging.INFO
        )
        self.logger = logging.getLogger(__name__)

    async def start(self, update: Update, context: CallbackContext):
        """Send welcome message when user sends /start"""
        welcome_text = """
üõ°Ô∏è **Malware Scanner Bot**

I can check if .exe files are safe!

**How to use:**
1. Forward any .exe file to me
2. I'll scan it with VirusTotal
3. You get instant security report

**Commands:**
/start - Show this help
/scan - Scan instructions

**I check:**
‚úÖ VirusTotal database
‚úÖ File metadata
‚úÖ Risk analysis
"""
        await update.message.reply_text(welcome_text)

    async def handle_document(self, update: Update, context: CallbackContext):
        """Step 3: Handle when user sends .exe file"""
        document = update.message.document
        
        # Check if it's an executable file
        if document.file_name and document.file_name.lower().endswith(('.exe', '.msi')):
            await update.message.reply_text("üîç **Scanning file...**\nPlease wait while I analyze the security.")
            
            # Step 4: Download and scan the file
            scan_result = await self.scan_file(update, document)
            
            # Step 5: Send results to user
            await self.send_results(update, scan_result)
        else:
            await update.message.reply_text("‚ùå Please send only .exe files for scanning.")

    async def scan_file(self, update: Update, document):
        """Step 4: 3-Step Scanning Process"""
        try:
            # Download the file
            file = await document.get_file()
            with tempfile.NamedTemporaryFile(delete=False, suffix='.exe') as temp_file:
                await file.download_to_drive(temp_file.name)
                file_path = temp_file.name

            # Step 4a: Calculate file hash
            file_hash = self.calculate_hash(file_path)
            
            # Step 4b: VirusTotal scan
            vt_result = self.virustotal_scan(file_hash)
            
            # Step 4c: Metadata analysis
            meta_result = self.metadata_scan(file_path, document.file_name)
            
            # Step 4d: Risk calculation
            risk_score = self.calculate_risk(vt_result, meta_result)
            
            scan_result = {
                'file_name': document.file_name,
                'file_hash': file_hash,
                'is_malicious': risk_score >= 7,
                'risk_score': risk_score,
                'vt_detections': f"{vt_result.get('positives', 0)}/{vt_result.get('total', 0)}",
                'warnings': meta_result['warnings'],
                'vt_link': f"https://www.virustotal.com/gui/file/{file_hash}"
            }
            
            # Cleanup
            os.unlink(file_path)
            
            return scan_result
            
        except Exception as e:
            self.logger.error(f"Scan error: {e}")
            return {'error': str(e)}

    def calculate_hash(self, file_path):
        """Step 4a: Calculate SHA256 hash"""
        sha256 = hashlib.sha256()
        with open(file_path, "rb") as f:
            for chunk in iter(lambda: f.read(4096), b""):
                sha256.update(chunk)
        return sha256.hexdigest()

    def virustotal_scan(self, file_hash):
        """Step 4b: Scan with VirusTotal"""
        try:
            url = "https://www.virustotal.com/vtapi/v2/file/report"
            params = {'apikey': self.vt_api_key, 'resource': file_hash}
            
            response = requests.get(url, params=params)
            if response.status_code == 200:
                data = response.json()
                
                if data['response_code'] == 1:
                    return {
                        'positives': data['positives'],
                        'total': data['total'],
                        'status': 'malicious' if data['positives'] > 0 else 'clean'
                    }
            
            return {'positives': 0, 'total': 0, 'status': 'unknown'}
            
        except Exception as e:
            self.logger.error(f"VirusTotal error: {e}")
            return {'positives': 0, 'total': 0, 'status': 'error'}

    def metadata_scan(self, file_path, file_name):
        """Step 4c: Analyze file metadata"""
        risk_score = 0
        warnings = []
        
        filename = file_name.lower()
        
        # Check for suspicious names
        suspicious_names = ['invoice', 'document', 'urgent', 'payment', 'password']
        if any(name in filename for name in suspicious_names):
            risk_score += 3
            warnings.append("Suspicious filename")
        
        # Check for double extensions
        if '.exe' in filename and any(ext in filename for ext in ['.pdf', '.doc', '.jpg', '.txt']):
            risk_score += 4
            warnings.append("Double extension detected")
        
        # Check file size
        try:
            file_size = os.path.getsize(file_path)
            if file_size < 1024:  # Less than 1KB
                risk_score += 2
                warnings.append("File unusually small")
            elif file_size > 50 * 1024 * 1024:  # Larger than 50MB
                risk_score += 1
                warnings.append("File very large")
        except:
            pass
        
        return {'risk_score': risk_score, 'warnings': warnings}

    def calculate_risk(self, vt_result, meta_result):
        """Step 4d: Calculate final risk score"""
        base_score = meta_result['risk_score']
        
        # Add VirusTotal risk
        if vt_result.get('status') == 'malicious':
            base_score += 8
        elif vt_result.get('status') == 'unknown':
            base_score += 2
            
        return min(base_score, 10)

    async def send_results(self, update: Update, scan_result):
        """Step 5: Send scan results to user"""
        if 'error' in scan_result:
            await update.message.reply_text("‚ùå Error scanning file. Please try again.")
            return
        
        if scan_result['is_malicious']:
            message = f"""
üö® **MALWARE DETECTED!**

üìÅ **File:** `{scan_result['file_name']}`
‚ö†Ô∏è **Risk Score:** {scan_result['risk_score']}/10
üîç **Detections:** {scan_result['vt_detections']}

**Warnings:**
{chr(10).join(['‚Ä¢ ' + warning for warning in scan_result['warnings']])}

‚ùå **RECOMMENDATION:** DO NOT RUN THIS FILE

[View Full Report]({scan_result['vt_link']})
"""
        else:
            message = f"""
‚úÖ **FILE IS SAFE**

üìÅ **File:** `{scan_result['file_name']}`
üü¢ **Risk Score:** {scan_result['risk_score']}/10
üîç **Detections:** {scan_result['vt_detections']}

**Status:** This file appears safe to run

[View Full Report]({scan_result['vt_link']})
"""
        
        await update.message.reply_text(message, parse_mode='Markdown')

    def run(self):
        """Step 6: Start the bot"""
        # Create application
        application = Application.builder().token(self.bot_token).build()
        
        # Add handlers
        application.add_handler(CommandHandler("start", self.start))
        application.add_handler(MessageHandler(filters.Document.ALL, self.handle_document))
        
        # Start bot
        print("ü§ñ Malware Scanner Bot is running...")
        print("üìç Go to Telegram and send /start to your bot")
        application.run_polling()

# Step 7: Configuration and Startup
if __name__ == "__main__":
    # REPLACE WITH YOUR API KEYS
    BOT_TOKEN = "8369948082:AAG1zICPiCXLc7Bvpkx9__sRZcFOKk8R3fM"      # From @BotFather
    VT_API_KEY = "d8ea4f4a1f2584e9b2f5987c252f7d8177189afaabe5a7ea57d028f357aa6a57"    # From VirusTotal
    
    # Create and run bot
    bot = MalwareScannerBot(BOT_TOKEN, VT_API_KEY)
    bot.run()